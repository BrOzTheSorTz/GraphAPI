<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API de Grafos</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        .container {
            max-width: 800px;
            margin-top: 30px;
        }
        .card {
            margin-bottom: 20px;
        }
        /* Estilos para el modal de resultados */
        .modal-resultados {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 700px;
            max-height: 80vh;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
        }
        .modal-body {
            padding: 20px;
            overflow-y: auto;
            max-height: calc(80vh - 130px);
        }
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            text-align: right;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        #resultados {
            white-space: pre-wrap;
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            overflow-y: auto;
        }
        #grafo-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            height: 500px;
            background-color: #f8f9fa;
            overflow: hidden;
        }
        .node {
            stroke: #fff;
            stroke-width: 1.5px;
        }
        .link {
            stroke: #999;
            stroke-opacity: 0.6;
        }
        .node text {
            font-size: 10px;
            pointer-events: none;
            fill: #333;
            stroke: #fff;
            stroke-width: 0.5px;
            paint-order: stroke;
        }
        .node-info {
            position: fixed;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            pointer-events: none;
            display: none;
            z-index: 100;
            transform: translate(-50%, -100%);
        }
        /* Estilos para notificaciones toast */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
        }
        .toast {
            min-width: 250px;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            animation: toast-in-right 0.7s;
        }
        .toast-success {
            border-left: 4px solid #28a745;
        }
        .toast-error {
            border-left: 4px solid #dc3545;
        }
        .toast-info {
            border-left: 4px solid #17a2b8;
        }
        .toast-header {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            background-color: rgba(255, 255, 255, 0.85);
            background-clip: padding-box;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            border-top-left-radius: calc(0.25rem - 1px);
            border-top-right-radius: calc(0.25rem - 1px);
        }
        .toast-body {
            padding: 0.75rem;
        }
        @keyframes toast-in-right {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        .success-text {
            color: #28a745;
            font-weight: bold;
        }
        .error-text {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="mb-4">API de Grafos</h1>
        
        <div class="card">
            <div class="card-header">
                Cargar archivos CSV
            </div>
            <div class="card-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="nodesFile" class="form-label">Archivo de nodos (nodes.csv)</label>
                        <input type="file" class="form-control" id="nodesFile" name="nodes" accept=".csv" required>
                        <div class="form-text">El archivo debe tener al menos las columnas "id" y "label".</div>
                    </div>
                    <div class="mb-3">
                        <label for="edgesFile" class="form-label">Archivo de aristas (edges.csv)</label>
                        <input type="file" class="form-control" id="edgesFile" name="edges" accept=".csv" required>
                        <div class="form-text">El archivo debe tener al menos las columnas "source" y "target".</div>
                    </div>
                    <button type="submit" class="btn btn-primary">Cargar Grafo</button>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                Operaciones
            </div>
            <div class="card-body">
                <div class="d-flex flex-wrap gap-2">
                    <button class="btn btn-outline-primary" onclick="infoGrafo()">Información del Grafo</button>
                    <button class="btn btn-outline-primary" onclick="listarNodos()">Listar Nodos</button>
                    <button class="btn btn-outline-primary" onclick="listarAristas()">Listar Aristas</button>
                    <button class="btn btn-outline-success" onclick="calcularMetricas()">Calcular Métricas</button>
                    <button class="btn btn-outline-danger" onclick="visualizarGrafo()">Visualizar Grafo</button>
                </div>
                <div class="mt-3">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control" id="buscarNodoInput" placeholder="Buscar nodo por nombre">
                        <button class="btn btn-outline-secondary" type="button" onclick="buscarNodo()">Buscar</button>
                    </div>
                    <div class="input-group">
                        <input type="text" class="form-control" id="nodoId1" placeholder="ID Nodo 1">
                        <input type="text" class="form-control" id="nodoId2" placeholder="ID Nodo 2">
                        <button class="btn btn-outline-secondary" type="button" onclick="calcularDistancia()">Calcular Distancia</button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal de resultados (popup) -->
        <div class="overlay" id="overlay"></div>
        <div class="modal-resultados" id="modal-resultados">
            <div class="modal-header">
                <h5>Resultados</h5>
                <button type="button" class="btn-close" aria-label="Cerrar" onclick="cerrarModal()"></button>
            </div>
            <div class="modal-body">
                <div id="resultados"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-sm btn-secondary" onclick="cerrarModal()">Cerrar</button>
                <button class="btn btn-sm btn-primary" onclick="document.getElementById('resultados').innerHTML = ''">Limpiar</button>
            </div>
        </div>
        
        <div id="grafo-container" class="d-none">
            <div class="d-flex justify-content-between p-2">
                <h5>Visualización del Grafo:</h5>
                <div>
                    <button class="btn btn-sm btn-outline-primary me-2" onclick="resetZoom()">Resetear Zoom</button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('grafo-container').classList.add('d-none')">Cerrar</button>
                </div>
            </div>
            <div id="node-info" class="node-info"></div>
            <svg id="grafo-svg" width="100%" height="470"></svg>
        </div>
    </div>

    <!-- Contenedor para notificaciones toast -->
    <div class="toast-container"></div>

    <script>
        // Funciones para el modal
        function mostrarModal() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('modal-resultados').style.display = 'flex';
        }
        
        function cerrarModal() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('modal-resultados').style.display = 'none';
        }
        
        // Función para mostrar resultados con formato mejorado
        function mostrarResultados(data) {
            const resultadosDiv = document.getElementById('resultados');
            
            // Si hay un mensaje de éxito, mostrarlo de forma destacada
            if (data.mensaje) {
                // Mostrar notificación toast
                mostrarNotificacion(data.mensaje, 'success');
                
                // Formatear el resultado para mostrar el mensaje de éxito destacado
                let contenido = `<div class="success-text mb-3">✅ ${data.mensaje}</div>`;
                delete data.mensaje; // Remover el mensaje para que no se duplique
                
                // Añadir el resto de datos formateados
                if (Object.keys(data).length > 0) {
                    contenido += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
                }
                
                resultadosDiv.innerHTML = contenido;
            } else {
                // JSON normal para otros resultados
                resultadosDiv.innerHTML = `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            
            // Mostrar el modal con los resultados
            mostrarModal();
        }

        // Función para mostrar errores con formato mejorado
        function mostrarError(mensaje) {
            const resultadosDiv = document.getElementById('resultados');
            
            // Mostrar notificación toast
            mostrarNotificacion(mensaje, 'error');
            
            // Formatear el error
            resultadosDiv.innerHTML = `<div class="error-text">❌ Error: ${mensaje}</div>`;
            
            // Mostrar el modal con el error
            mostrarModal();
        }
        
        // Función para mostrar notificaciones tipo toast
        function mostrarNotificacion(mensaje, tipo = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            
            // Crear el elemento toast
            const toast = document.createElement('div');
            toast.className = `toast toast-${tipo}`;
            
            // Título según el tipo
            let titulo = tipo === 'success' ? 'Éxito' : 
                         tipo === 'error' ? 'Error' : 'Información';
            
            // Icono según el tipo
            let icono = tipo === 'success' ? '✅' : 
                       tipo === 'error' ? '❌' : 'ℹ️';
            
            // Contenido del toast
            toast.innerHTML = `
                <div class="toast-header">
                    <strong class="me-auto">${icono} ${titulo}</strong>
                    <button type="button" class="btn-close" aria-label="Cerrar" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
                <div class="toast-body">
                    ${mensaje}
                </div>
            `;
            
            // Añadir al contenedor
            toastContainer.appendChild(toast);
            
            // Eliminar después de 5 segundos
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.remove();
                }
            }, 5000);
        }

        // Cargar grafo
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('nodes', document.getElementById('nodesFile').files[0]);
            formData.append('edges', document.getElementById('edgesFile').files[0]);
            
            fetch('/cargar-grafo', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                } else {
                    mostrarResultados(data);
                }
            })
            .catch(error => mostrarError(error.message));
        });

        // Información del grafo
        function infoGrafo() {
            fetch('/info-grafo')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                } else {
                    // Si no hay un mensaje de éxito explícito, añadimos uno
                    if (!data.mensaje) {
                        data.mensaje = "Información del grafo obtenida correctamente";
                    }
                    mostrarResultados(data);
                }
            })
            .catch(error => mostrarError(error.message));
        }

        // Listar nodos
        function listarNodos() {
            fetch('/nodos')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                } else {
                    // Añadir mensaje de éxito
                    data.mensaje = `Listado de ${data.nodos?.length || 0} nodos obtenido correctamente`;
                    mostrarResultados(data);
                }
            })
            .catch(error => mostrarError(error.message));
        }

        // Listar aristas
        function listarAristas() {
            fetch('/aristas')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                } else {
                    // Añadir mensaje de éxito
                    data.mensaje = `Listado de ${data.aristas?.length || 0} aristas obtenido correctamente`;
                    mostrarResultados(data);
                }
            })
            .catch(error => mostrarError(error.message));
        }

        // Calcular métricas
        function calcularMetricas() {
            mostrarNotificacion('Calculando métricas, por favor espere...', 'info');
            
            fetch('/calcular-metricas', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                } else {
                    mostrarResultados(data);
                }
            })
            .catch(error => mostrarError(error.message));
        }

        // Buscar nodo por nombre
        function buscarNodo() {
            const nombre = document.getElementById('buscarNodoInput').value;
            if (!nombre) {
                return mostrarError('Debe ingresar un nombre para buscar');
            }
            
            fetch(`/buscar-nodo/${nombre}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                } else {
                    data.mensaje = `Nodo "${nombre}" encontrado correctamente`;
                    mostrarResultados(data);
                }
            })
            .catch(error => mostrarError(error.message));
        }

        // Calcular distancia entre nodos
        function calcularDistancia() {
            const nodo1 = document.getElementById('nodoId1').value;
            const nodo2 = document.getElementById('nodoId2').value;
            
            if (!nodo1 || !nodo2) {
                return mostrarError('Debe ingresar los IDs de ambos nodos');
            }
            
            fetch(`/distancia/${nodo1}/${nodo2}`)
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    mostrarError(data.error);
                } else {
                    data.mensaje = `Distancia calculada correctamente`;
                    mostrarResultados(data);
                }
            })
            .catch(error => mostrarError(error.message));
        }

        // Visualizar grafo
        function visualizarGrafo() {
            mostrarNotificacion('Generando visualización del grafo...', 'info');
            
            fetch('/grafo-visualizacion')
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    return mostrarError(data.error);
                }
                renderGrafo(data);
                mostrarNotificacion(`Grafo visualizado con ${data.nodes.length} nodos y ${data.links.length} aristas`, 'success');
            })
            .catch(error => mostrarError(error.message));
        }

        // Renderizar el grafo con D3.js
        function renderGrafo(data) {
            // Mostrar el contenedor
            document.getElementById('grafo-container').classList.remove('d-none');
            
            // Limpiar el SVG
            d3.select("#grafo-svg").selectAll("*").remove();
            
            const svg = d3.select("#grafo-svg"),
                  width = svg.node().getBoundingClientRect().width,
                  height = svg.node().getBoundingClientRect().height;
            
            // Crear grupo principal para aplicar zoom
            const g = svg.append("g");
            
            // Configurar el zoom
            const zoom = d3.zoom()
                .scaleExtent([0.1, 10])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });
            
            // Aplicar zoom al SVG
            svg.call(zoom);
            
            // Resetear zoom
            window.resetZoom = function() {
                svg.transition().duration(750).call(
                    zoom.transform,
                    d3.zoomIdentity
                );
            };
            
            // Crear la simulación de fuerzas
            const simulation = d3.forceSimulation(data.nodes)
                .force("link", d3.forceLink(data.links).id(d => d.id).distance(100))
                .force("charge", d3.forceManyBody().strength(-300))
                .force("center", d3.forceCenter(width / 2, height / 2))
                .force("collision", d3.forceCollide().radius(30));
            
            // Crear las líneas (enlaces)
            const link = g.append("g")
                .attr("class", "links")
                .selectAll("line")
                .data(data.links)
                .enter().append("line")
                .attr("class", "link");
            
            // Crear los nodos
            const node = g.append("g")
                .attr("class", "nodes")
                .selectAll("g")
                .data(data.nodes)
                .enter().append("g")
                .attr("class", "node")
                .attr("id", d => `node-${d.id.replace(/[^a-zA-Z0-9]/g, "_")}`)
                .on("click", function(event, d) {
                    event.stopPropagation();
                    mostrarInfoNodo(d, event, this);
                })
                .call(d3.drag()
                    .on("start", dragstarted)
                    .on("drag", dragged)
                    .on("end", dragended));
            
            // Añadir círculos a los nodos
            node.append("circle")
                .attr("r", d => Math.max(5, Math.min(15, d.value)))
                .attr("fill", d => getRandomColor(d.id));
            
            // Añadir etiquetas a los nodos
            node.append("text")
                .attr("dy", -10)
                .text(d => d.label || d.id)
                .attr("text-anchor", "middle");
            
            // Añadir título al pasar el ratón
            node.append("title")
                .text(d => d.label || d.id);
            
            // Actualización en cada tick de la simulación
            simulation.on("tick", () => {
                link
                    .attr("x1", d => Math.max(10, Math.min(width - 10, d.source.x)))
                    .attr("y1", d => Math.max(10, Math.min(height - 10, d.source.y)))
                    .attr("x2", d => Math.max(10, Math.min(width - 10, d.target.x)))
                    .attr("y2", d => Math.max(10, Math.min(height - 10, d.target.y)));
                
                node.attr("transform", d => `translate(${Math.max(10, Math.min(width - 10, d.x))},${Math.max(10, Math.min(height - 10, d.y))})`);
            });
            
            // Funciones para el arrastre
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // Generar colores aleatorios pero consistentes para cada nodo
            function getRandomColor(id) {
                // Asegurarse de que id sea una cadena
                id = String(id || '');
                // Verificar si id está vacío
                if (!id) {
                    return 'hsl(0, 70%, 60%)'; // Color rojo por defecto
                }
                // Genera un color basado en el id para que el mismo nodo siempre tenga el mismo color
                const hash = id.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                const hue = hash % 360;
                return `hsl(${hue}, 70%, 60%)`;
            }
            
            // Función para mostrar información del nodo
            function mostrarInfoNodo(nodo, event, nodeElement) {
                event.preventDefault();
                const nodeInfo = document.getElementById('node-info');
                
                // Log para depuración
                console.log('Mostrando info de nodo:', nodo);
                
                // Verificar que el nodo tiene un ID válido
                if (!nodo || !nodo.id) {
                    console.error('Error: Nodo sin ID válido', nodo);
                    nodeInfo.innerHTML = `<p class="error-text">Error: El nodo no tiene un ID válido</p>`;
                    nodeInfo.style.left = `${event.clientX}px`;
                    nodeInfo.style.top = `${event.clientY}px`;
                    nodeInfo.style.display = 'block';
                    return;
                }
                
                // Mostrar información de carga
                nodeInfo.innerHTML = `<p>Cargando información del nodo ${nodo.id}...</p>`;
                nodeInfo.style.left = `${event.clientX}px`;
                nodeInfo.style.top = `${event.clientY}px`;
                nodeInfo.style.display = 'block';
                
                const url = `/nodo/${encodeURIComponent(nodo.id)}`;
                console.log('Solicitando datos de:', url);
                
                // Obtener información detallada del nodo
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            if (response.status === 404) {
                                throw new Error(`No se encontró el nodo con ID ${nodo.id}`);
                            } else {
                                throw new Error(`Error del servidor: ${response.status}`);
                            }
                        }
                        
                        // Verificar que la respuesta es JSON antes de parsearla
                        const contentType = response.headers.get('content-type');
                        if (contentType && contentType.includes('application/json')) {
                            return response.json();
                        } else {
                            // Si no es JSON, leer como texto y mostrar error
                            return response.text().then(text => {
                                console.error('Respuesta no es JSON:', text);
                                throw new Error('La respuesta del servidor no es JSON válido');
                            });
                        }
                    })
                    .then(data => {
                        // Verificar si hay error
                        if (data.error) {
                            nodeInfo.innerHTML = `<p class="error-text">Error: ${data.error}</p>`;
                        } else {
                            // Crear contenido HTML
                            let html = `
                                <h6>Nodo: ${data.nombre}</h6>
                                <p><strong>ID:</strong> ${data.id}</p>
                                <p><strong>Adyacentes:</strong> ${data.num_adyacentes}</p>
                            `;
                            
                            // Función auxiliar para formatear valores numéricos
                            const formatNumber = (value) => {
                                return (value !== null && value !== undefined) ? parseFloat(value).toFixed(3) : '0.000';
                            };
                            
                            // Añadir métricas si están disponibles
                            if (data.centralidad !== undefined) {
                                html += `<p><strong>Centralidad:</strong> ${formatNumber(data.centralidad)}</p>`;
                            }
                            if (data.cercania !== undefined) {
                                html += `<p><strong>Cercanía:</strong> ${formatNumber(data.cercania)}</p>`;
                            }
                            if (data.intermediacion !== undefined) {
                                html += `<p><strong>Intermediación:</strong> ${formatNumber(data.intermediacion)}</p>`;
                            }
                            if (data.pagerank !== undefined) {
                                html += `<p><strong>PageRank:</strong> ${formatNumber(data.pagerank)}</p>`;
                            }
                            // Añadir métricas de HITS
                            if (data.authority !== undefined) {
                                html += `<p><strong>Authority:</strong> ${formatNumber(data.authority)}</p>`;
                            }
                            if (data.hub !== undefined) {
                                html += `<p><strong>Hub:</strong> ${formatNumber(data.hub)}</p>`;
                            }
                            
                            nodeInfo.innerHTML = html;
                        }
                    })
                    .catch(error => {
                        console.error("Error al obtener información del nodo:", error);
                        nodeInfo.innerHTML = `<p class="error-text">❌ Error: ${error.message}</p>`;
                    });
            }
            
            // Cerrar la información del nodo al hacer clic en otra parte
            svg.on('click', () => {
                document.getElementById('node-info').style.display = 'none';
            });
        }
        
        // Cerrar modal al hacer clic fuera
        document.getElementById('overlay').addEventListener('click', function() {
            cerrarModal();
        });
    </script>
</body>
</html> 